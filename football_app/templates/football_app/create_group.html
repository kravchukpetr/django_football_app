{% extends 'football_app/base.html' %}

{% block title %}Create Group - Football Stats{% endblock %}

{% block content %}
<style>
/* Custom styling for multi-select dropdowns */
.form-select[size] {
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.form-select[size]:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-select option {
    padding: 0.375rem 0.75rem;
}

.form-select option:disabled {
    color: #6c757d;
    font-style: italic;
}

/* Add some spacing between the dropdowns */
.mb-3:has(.form-select[size]) {
    margin-bottom: 1.5rem !important;
}
</style>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-success text-white text-center">
                <h4 class="mb-0">
                    <i class="fas fa-plus"></i> Create New Group
                </h4>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }} *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.name.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.name.help_text %}
                            <div class="form-text">{{ form.name.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.description.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.description.help_text %}
                            <div class="form-text">{{ form.description.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.countries.id_for_label }}" class="form-label">{{ form.countries.label }}</label>
                        {{ form.countries }}
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Hold Ctrl (or Cmd on Mac) to select multiple countries
                        </small>
                        {% if form.countries.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.countries.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.countries.help_text %}
                            <div class="form-text">{{ form.countries.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.leagues.id_for_label }}" class="form-label">{{ form.leagues.label }} *</label>
                        <div id="leagues-container">
                            {{ form.leagues }}
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Hold Ctrl (or Cmd on Mac) to select multiple leagues
                        </small>
                        {% if form.leagues.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.leagues.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.leagues.help_text %}
                            <div class="form-text">{{ form.leagues.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.max_members.id_for_label }}" class="form-label">{{ form.max_members.label }} *</label>
                                {{ form.max_members }}
                                {% if form.max_members.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.max_members.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if form.max_members.help_text %}
                                    <div class="form-text">{{ form.max_members.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    {{ form.is_private }}
                                    <label class="form-check-label" for="{{ form.is_private.id_for_label }}">
                                        {{ form.is_private.label }}
                                    </label>
                                </div>
                                {% if form.is_private.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.is_private.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if form.is_private.help_text %}
                                    <div class="form-text">{{ form.is_private.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'my_groups' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Create Group
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const countriesSelect = document.getElementById('id_countries');
    const leaguesSelect = document.getElementById('id_leagues');
    const leaguesContainer = document.getElementById('leagues-container');
    
    // Store all available leagues for filtering
    let allLeagues = [];
    
    // Function to populate all leagues initially
    function populateAllLeagues() {
        // Get all existing options from the form
        allLeagues = Array.from(leaguesSelect.options).map(option => ({
            value: option.value,
            text: option.textContent,
            selected: option.selected
        }));
    }
    
    // Function to update leagues based on selected countries
    function updateLeagues() {
        const selectedCountries = Array.from(countriesSelect.selectedOptions)
            .map(option => option.value);
        
        if (selectedCountries.length === 0) {
            // Hide all leagues
            Array.from(leaguesSelect.options).forEach(option => {
                option.style.display = 'none';
            });
            return;
        }
        
        // Show loading state
        const loadingOption = document.createElement('option');
        loadingOption.disabled = true;
        loadingOption.textContent = 'Loading leagues...';
        loadingOption.style.display = 'block';
        leaguesSelect.innerHTML = '';
        leaguesSelect.appendChild(loadingOption);
        
        // Make AJAX request to get leagues
        fetch('{% url "get_leagues_by_country" %}?' + selectedCountries.map(id => 'country_ids[]=' + id).join('&'))
            .then(response => response.json())
            .then(data => {
                // Clear existing options
                leaguesSelect.innerHTML = '';
                
                if (data.leagues && data.leagues.length > 0) {
                    // Add leagues as options
                    data.leagues.forEach(league => {
                        const option = document.createElement('option');
                        option.value = league.id;
                        option.textContent = league.display_name;
                        leaguesSelect.appendChild(option);
                    });
                } else {
                    // No leagues found
                    const noLeaguesOption = document.createElement('option');
                    noLeaguesOption.disabled = true;
                    noLeaguesOption.textContent = 'No leagues found for the selected countries.';
                    leaguesSelect.appendChild(noLeaguesOption);
                }
            })
            .catch(error => {
                console.error('Error fetching leagues:', error);
                leaguesSelect.innerHTML = '';
                const errorOption = document.createElement('option');
                errorOption.disabled = true;
                errorOption.textContent = 'Error loading leagues. Please try again.';
                leaguesSelect.appendChild(errorOption);
            });
    }
    
    // Add event listener to country select
    countriesSelect.addEventListener('change', updateLeagues);
    
    // Initial call to set up the leagues display
    updateLeagues();
});
</script>
{% endblock %}
